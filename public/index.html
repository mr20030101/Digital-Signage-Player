<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Signage Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        #player-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: #000;
        }

        .region {
            position: absolute;
            overflow: hidden;
            background: #000;
        }

        .region img,
        .region video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #setup-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            color: white;
            text-align: center;
            padding: 40px;
        }

        #setup-screen h1 {
            font-size: 48px;
            margin-bottom: 20px;
        }

        #setup-screen .code {
            font-size: 72px;
            font-weight: bold;
            letter-spacing: 10px;
            margin: 40px 0;
            padding: 20px 40px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        #setup-screen p {
            font-size: 24px;
            color: #aaa;
        }

        #reset-button {
            display: none;
            margin-top: 20px;
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #reset-button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        #reset-button.visible {
            display: inline-block;
        }

        .loading {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 14px;
        }

        .error {
            display: none;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            background: rgba(255, 0, 0, 0.8);
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 16px;
        }

        #fullscreen-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 9999;
        }

        #fullscreen-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            border-color: rgba(255, 255, 255, 0.6);
            transform: scale(1.1);
        }

        #fullscreen-btn svg {
            width: 30px;
            height: 30px;
            fill: white;
        }

        #fullscreen-btn.active {
            display: flex;
        }

        #heartbeat-indicator {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-family: monospace;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: none;
            z-index: 9999;
        }

        #heartbeat-indicator.active {
            display: block;
        }

        #heartbeat-indicator .pulse {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 1s ease-in-out infinite;
        }

        #heartbeat-indicator.checking .pulse {
            background: #FFC107;
            animation: pulse 0.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        #debug-log {
            position: fixed;
            bottom: 20px;
            left: 20px;
            width: 400px;
            max-height: 300px;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 11px;
            border: 2px solid rgba(0, 255, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            display: none;
            z-index: 9998;
        }

        #debug-log.active {
            display: block;
        }

        #debug-log-header {
            background: rgba(0, 255, 0, 0.2);
            padding: 8px 12px;
            border-bottom: 1px solid rgba(0, 255, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #debug-log-header h3 {
            margin: 0;
            font-size: 12px;
            font-weight: bold;
        }

        #debug-log-close {
            background: none;
            border: none;
            color: #00ff00;
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #debug-log-close:hover {
            color: #ff0000;
        }

        #debug-log-content {
            padding: 10px;
            max-height: 250px;
            overflow-y: auto;
            line-height: 1.4;
        }

        #debug-log-content::-webkit-scrollbar {
            width: 8px;
        }

        #debug-log-content::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
        }

        #debug-log-content::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 0, 0.3);
            border-radius: 4px;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
        }

        .log-entry .timestamp {
            color: #888;
            margin-right: 8px;
        }

        .log-entry.info { color: #00ff00; }
        .log-entry.warning { color: #FFC107; }
        .log-entry.error { color: #ff0000; }
        .log-entry.success { color: #4CAF50; }

        #debug-log-toggle {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            border: 2px solid rgba(0, 255, 0, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            z-index: 9997;
            transition: all 0.3s ease;
        }

        #debug-log-toggle:hover {
            background: rgba(0, 255, 0, 0.2);
            transform: scale(1.1);
        }

        #debug-log-toggle.hidden {
            display: none;
        }

        #force-refresh-btn {
            position: fixed;
            bottom: 80px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #FFC107;
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            z-index: 9997;
            transition: all 0.3s ease;
        }

        #force-refresh-btn:hover {
            background: rgba(255, 193, 7, 0.2);
            transform: scale(1.1) rotate(180deg);
        }

        #force-refresh-btn:active {
            transform: scale(0.95) rotate(180deg);
        }
    </style>
</head>
<body>
    <div id="setup-screen">
        <h1>Digital Signage Player</h1>
        
        <div id="code-input-section" style="margin-top: 30px; max-width: 600px;">
            <p style="margin-bottom: 15px;">Enter your display code from the CMS:</p>
            <input 
                id="code-input" 
                type="text"
                placeholder="Enter display code (e.g., ABC123)"
                style="width: 100%; padding: 15px; border-radius: 10px; border: 2px solid #444; background: rgba(255,255,255,0.1); color: white; font-family: monospace; font-size: 18px; text-align: center; text-transform: uppercase; letter-spacing: 2px;"
                maxlength="10"
            />
            <button 
                id="save-code-btn"
                style="margin-top: 15px; padding: 12px 30px; background: #2196F3; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%;"
            >
                Continue
            </button>
            <p style="margin-top: 15px; font-size: 14px; color: #aaa;">
                Get your display code from the CMS Displays page
            </p>
        </div>

        <div id="token-input-section" style="display: none; margin-top: 30px; max-width: 600px;">
            <p>Display Code:</p>
            <div class="code" id="display-code" style="font-size: 48px; margin: 20px 0;">Loading...</div>
            <p style="margin-bottom: 15px;">Enter the global player token from CMS Settings:</p>
            <textarea 
                id="token-input" 
                placeholder="Paste the global player token here..."
                style="width: 100%; padding: 15px; border-radius: 10px; border: 2px solid #444; background: rgba(255,255,255,0.1); color: white; font-family: monospace; font-size: 14px; resize: vertical; min-height: 100px;"
            ></textarea>
            <button 
                id="save-token-btn"
                style="margin-top: 15px; padding: 12px 30px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; width: 100%;"
            >
                Save Token & Connect
            </button>
            <button 
                id="reset-btn"
                style="margin-top: 10px; padding: 10px 20px; background: rgba(255,255,255,0.1); color: #aaa; border: 1px solid #444; border-radius: 8px; font-size: 14px; cursor: pointer; width: 100%;"
            >
                Reset & Enter New Code
            </button>
            <p style="margin-top: 15px; font-size: 14px; color: #aaa;">
                Get the global player token from CMS ‚Üí Settings page. This token is shared by all players.
            </p>
        </div>
        <p id="setup-message" style="margin-top: 20px;">Enter your display code to begin</p>
        <button id="reset-button" onclick="resetPlayer()">
            <svg style="display: inline-block; width: 20px; height: 20px; margin-right: 8px; vertical-align: middle;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Reset & Enter New Code
        </button>
    </div>

    <div id="player-container" style="display: none;"></div>
    <div class="loading" id="loading">Updating content...</div>
    <div class="error" id="error"></div>

    <button id="fullscreen-btn" title="Toggle Fullscreen">
        <svg id="fullscreen-icon" viewBox="0 0 24 24">
            <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
        </svg>
        <svg id="exit-fullscreen-icon" viewBox="0 0 24 24" style="display: none;">
            <path d="M5 16h3v3h2v-5H5v2zm3-8H5v2h5V5H8v3zm6 11h2v-3h3v-2h-5v5zm2-11V5h-2v5h5V8h-3z"/>
        </svg>
    </button>

    <div id="heartbeat-indicator">
        <span class="pulse"></span>
        <span id="heartbeat-text">Heartbeat Active</span>
    </div>

    <button id="debug-log-toggle" title="Toggle Debug Log">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
        </svg>
    </button>

    <button id="force-refresh-btn" title="Force Refresh Content">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M21.5 2v6h-6M2.5 22v-6h6M2 11.5a10 10 0 0 1 18.8-4.3M22 12.5a10 10 0 0 1-18.8 4.2"/>
        </svg>
    </button>

    <div id="debug-log">
        <div id="debug-log-header">
            <h3>üîç Debug Log</h3>
            <button id="debug-log-close">√ó</button>
        </div>
        <div id="debug-log-content"></div>
    </div>

    <script>
        // Dynamic API URL - defaults to localhost, can be overridden via query param or environment
        const getApiUrl = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const apiParam = urlParams.get('api');
            if (apiParam) return apiParam;
            
            // Try to detect from current host
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            
            // If running on localhost/127.0.0.1, use port 8000
            if (hostname === 'localhost' || hostname === '127.0.0.1') {
                return `${protocol}//localhost:8000/api`;
            }
            
            // Otherwise assume API is on same host
            return `${protocol}//${hostname}/api`;
        };
        
        const API_URL = getApiUrl();
        console.log('Using API URL:', API_URL);
        
        let displayCode = null;
        let playerToken = null;
        let currentLayout = null;
        let currentPlaylistId = null; // Track current playlist ID
        let currentContentType = null; // Track what's currently playing: 'layout' or 'schedule'
        let heartbeatInterval = null; // Heartbeat for schedule checking (5 seconds)
        let debugLogEnabled = true; // Debug log visibility
        const maxLogEntries = 50; // Maximum log entries to keep

        // Debug logging functions
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('en-US', { 
                hour12: false, 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit' 
            });
            
            const logContent = document.getElementById('debug-log-content');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.innerHTML = `<span class="timestamp">[${timestamp}]</span>${message}`;
            
            logContent.appendChild(entry);
            
            // Remove old entries if too many
            const entries = logContent.querySelectorAll('.log-entry');
            if (entries.length > maxLogEntries) {
                entries[0].remove();
            }
            
            // Auto-scroll to bottom
            logContent.scrollTop = logContent.scrollHeight;
            
            // Also log to console
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debug-log-content').innerHTML = '';
        }

        function toggleDebugLog() {
            const debugLog = document.getElementById('debug-log');
            const toggle = document.getElementById('debug-log-toggle');
            
            if (debugLog.classList.contains('active')) {
                debugLog.classList.remove('active');
                toggle.classList.remove('hidden');
            } else {
                debugLog.classList.add('active');
                toggle.classList.add('hidden');
            }
        }

        // Get or set display code
        function getDisplayCode() {
            return localStorage.getItem('displayCode');
        }

        function setDisplayCode(code) {
            localStorage.setItem('displayCode', code.toUpperCase());
            displayCode = code.toUpperCase();
            addLog(`Display code set: ${code.toUpperCase()}`, 'info');
        }

        // Get stored token
        function getStoredToken() {
            return localStorage.getItem('playerToken');
        }

        // Save token
        function saveToken(token) {
            localStorage.setItem('playerToken', token);
            playerToken = token;
            addLog('Player token saved', 'success');
        }

        // Show token input
        function showTokenInput() {
            document.getElementById('token-input-section').style.display = 'block';
            document.getElementById('setup-message').textContent = 'Please enter the global player token from CMS Settings';
        }

        // Setup code input
        function setupCodeInput() {
            const codeInput = document.getElementById('code-input');
            const saveCodeBtn = document.getElementById('save-code-btn');
            
            // Auto-uppercase as user types
            codeInput.addEventListener('input', (e) => {
                e.target.value = e.target.value.toUpperCase();
            });
            
            saveCodeBtn.addEventListener('click', () => {
                const code = codeInput.value.trim();
                if (!code) {
                    alert('Please enter a display code');
                    return;
                }
                if (code.length < 3) {
                    alert('Display code must be at least 3 characters');
                    return;
                }
                
                setDisplayCode(code);
                document.getElementById('code-input-section').style.display = 'none';
                document.getElementById('token-input-section').style.display = 'block';
                document.getElementById('display-code').textContent = code;
                document.getElementById('setup-message').textContent = 'Now enter the global player token';
            });
            
            // Allow Enter key to submit
            codeInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveCodeBtn.click();
                }
            });
        }

        // Setup token save button
        function setupTokenInput() {
            document.getElementById('save-token-btn').addEventListener('click', async () => {
                const token = document.getElementById('token-input').value.trim();
                if (!token) {
                    alert('Please enter a valid token');
                    return;
                }
                saveToken(token);
                document.getElementById('setup-message').textContent = 'Token saved! Connecting...';
                
                // Try to register and wait for it to complete
                const success = await registerDisplay();
                if (success) {
                    // Wait a moment for the backend to process
                    setTimeout(() => {
                        checkForContent();
                        // Note: heartbeat will be started by checkForContent() once content is loaded
                    }, 1000);
                }
            });
            
            // Reset button
            document.getElementById('reset-btn').addEventListener('click', () => {
                if (confirm('This will clear your saved code and token. Continue?')) {
                    localStorage.removeItem('displayCode');
                    localStorage.removeItem('playerToken');
                    location.reload();
                }
            });
        }

        // Register display with backend
        async function registerDisplay() {
            if (!playerToken) {
                addLog('No token found, skipping registration', 'warning');
                return false;
            }

            addLog(`Registering display ${displayCode}...`, 'info');

            // Hide reset button when attempting to register
            hideResetButton();

            try {
                const response = await fetch(`${API_URL}/player/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Player-Token': playerToken,
                        'Accept': 'application/json',
                    },
                    body: JSON.stringify({
                        code: displayCode,
                        name: `Display ${displayCode}`,
                        resolution: `${window.screen.width}x${window.screen.height}`,
                    }),
                });

                console.log('Registration response status:', response.status);

                if (response.ok) {
                    const data = await response.json();
                    addLog(`‚úì Display registered successfully`, 'success');
                    document.getElementById('setup-message').textContent = 'Connected! Loading content...';
                    return true;
                } else {
                    const error = await response.json();
                    
                    if (response.status === 401) {
                        addLog('‚úó Registration failed: Invalid token', 'error');
                        showError('Invalid token. Please check your token in CMS Settings.');
                        document.getElementById('setup-message').textContent = 'Invalid token. Please re-enter.';
                        localStorage.removeItem('playerToken');
                        playerToken = null;
                        document.getElementById('token-input-section').style.display = 'block';
                        showResetButton();
                    } else if (response.status === 404) {
                        addLog(`‚úó Registration failed: Display code "${displayCode}" not found`, 'error');
                        showError(`Display code "${displayCode}" not found. Please verify the code in the CMS.`);
                        document.getElementById('setup-message').textContent = 
                            `Display code "${displayCode}" not found. Please check the code in CMS.`;
                        showResetButton();
                    } else if (response.status === 403) {
                        addLog('‚úó Registration failed: Access denied (IP not whitelisted)', 'error');
                        showError('Access denied. Your IP may not be whitelisted.');
                        document.getElementById('setup-message').textContent = 'Access denied. Check IP whitelist settings.';
                        showResetButton();
                    } else {
                        addLog(`‚úó Registration failed: ${error.message || 'Unknown error'}`, 'error');
                        showError(`Connection failed: ${error.message || 'Unknown error'}`);
                        document.getElementById('setup-message').textContent = 'Connection failed. Please try again.';
                        showResetButton();
                    }
                    return false;
                }
            } catch (error) {
                addLog(`‚úó Network error during registration: ${error.message}`, 'error');
                showError(`Network error: ${error.message}`);
                document.getElementById('setup-message').textContent = 'Network error. Check API URL and connection.';
                showResetButton();
                return false;
            }
        }

        // Check for assigned content
        async function checkForContent() {
            // Check if we have a token
            if (!playerToken) {
                console.log('No token found, showing token input');
                showTokenInput();
                return;
            }

            // Show heartbeat checking state
            const heartbeatIndicator = document.getElementById('heartbeat-indicator');
            const heartbeatText = document.getElementById('heartbeat-text');
            heartbeatIndicator.classList.add('checking');
            heartbeatText.textContent = 'Checking for updates...';

            const currentTime = new Date().toLocaleString('en-US', { timeZone: 'Asia/Singapore' });
            addLog(`‚ü≥ Checking for content updates... (${currentTime})`, 'info');

            try {
                const response = await fetch(`${API_URL}/player/${displayCode}/content`, {
                    headers: {
                        'X-Player-Token': playerToken,
                        'Accept': 'application/json',
                    }
                });
                
                console.log('Content response status:', response.status);
                
                if (response.status === 401) {
                    // Token is invalid
                    const errorData = await response.json();
                    addLog('‚úó Authentication failed: Invalid token', 'error');
                    localStorage.removeItem('playerToken');
                    playerToken = null;
                    showError('Invalid token. Please enter the correct token from CMS Settings.');
                    document.getElementById('setup-screen').style.display = 'flex';
                    document.getElementById('player-container').style.display = 'none';
                    document.getElementById('fullscreen-btn').classList.remove('active');
                    document.getElementById('token-input-section').style.display = 'block';
                    document.getElementById('setup-message').textContent = 'Token expired or invalid. Please re-enter.';
                    showResetButton();
                    stopHeartbeat();
                    return;
                }
                
                if (response.status === 404) {
                    // Display not registered yet
                    const errorData = await response.json();
                    addLog(`‚úó Display code "${displayCode}" not found`, 'error');
                    document.getElementById('setup-screen').style.display = 'flex';
                    document.getElementById('player-container').style.display = 'none';
                    document.getElementById('fullscreen-btn').classList.remove('active');
                    document.getElementById('code-input-section').style.display = 'none';
                    document.getElementById('token-input-section').style.display = 'none';
                    document.getElementById('setup-message').textContent = 
                        `Display code "${displayCode}" not found. Please check the code in CMS.`;
                    
                    // Show reset button
                    showResetButton();
                    showError('Display not found. Please check your display code.');
                    stopHeartbeat();
                    setTimeout(checkForContent, 10000);
                    return;
                }
                
                if (response.status === 403) {
                    // Access denied
                    const errorData = await response.json();
                    addLog('‚úó Access denied: IP not whitelisted', 'error');
                    showError('Access denied. Your IP may not be whitelisted.');
                    document.getElementById('setup-message').textContent = 'Access denied. Check IP whitelist settings.';
                    showResetButton();
                    stopHeartbeat();
                    setTimeout(checkForContent, 30000);
                    return;
                }
                
                if (response.ok) {
                    const data = await response.json();
                    addLog(`‚úì Content received - Type: ${data.type || 'unknown'}`, 'info');
                    
                    // Update heartbeat indicator
                    heartbeatIndicator.classList.remove('checking');
                    
                    // Handle scheduled playlist
                    if (data.type === 'schedule' && data.playlist) {
                        addLog(`üìÖ Active schedule found: "${data.playlist.name}" (ID: ${data.playlist.id})`, 'success');
                        addLog(`   Start: ${data.schedule.start_time} | End: ${data.schedule.end_time}`, 'info');
                        addLog(`   Current content type: ${currentContentType}, Current playlist: ${currentPlaylistId}`, 'info');
                        heartbeatText.textContent = `Schedule Active: ${data.playlist.name}`;
                        
                        // Check if we need to switch
                        const needsSwitch = currentContentType !== 'schedule' || currentPlaylistId !== data.playlist.id;
                        addLog(`   Needs switch: ${needsSwitch}`, 'info');
                        
                        if (needsSwitch) {
                            addLog(`‚ñ∂ Switching to scheduled playlist (${data.playlist.contents?.length || 0} items)`, 'success');
                            document.getElementById('setup-screen').style.display = 'none';
                            document.getElementById('player-container').style.display = 'block';
                            document.getElementById('fullscreen-btn').classList.add('active');
                            hideResetButton();
                            renderScheduledPlaylist(data.playlist);
                            currentContentType = 'schedule';
                        } else {
                            addLog(`   Already showing this schedule, no switch needed`, 'info');
                        }
                        startHeartbeat();
                    }
                    // Handle scheduled layout
                    else if (data.type === 'schedule_layout' && data.layout) {
                        addLog(`üìÖ Active schedule found: "${data.layout.name}" (Layout ID: ${data.layout.id})`, 'success');
                        addLog(`   Start: ${data.schedule.start_time} | End: ${data.schedule.end_time}`, 'info');
                        addLog(`   Current content type: ${currentContentType}, Current layout: ${currentLayout?.id}`, 'info');
                        heartbeatText.textContent = `Schedule Active: ${data.layout.name}`;
                        
                        // Check if we need to switch
                        const needsSwitch = currentContentType !== 'schedule_layout' || !currentLayout || currentLayout.id !== data.layout.id;
                        addLog(`   Needs switch: ${needsSwitch}`, 'info');
                        
                        if (needsSwitch) {
                            addLog(`‚ñ∂ Switching to scheduled layout (${data.layout.regions?.length || 0} regions)`, 'success');
                            document.getElementById('setup-screen').style.display = 'none';
                            document.getElementById('player-container').style.display = 'block';
                            document.getElementById('fullscreen-btn').classList.add('active');
                            hideResetButton();
                            renderLayout(data.layout);
                            currentContentType = 'schedule_layout';
                        } else {
                            addLog(`   Already showing this scheduled layout, no switch needed`, 'info');
                        }
                        startHeartbeat();
                    }
                    // Handle layout
                    else if (data.type === 'layout' && data.layout) {
                        addLog(`üìê No active schedule, showing default layout: "${data.layout.name}" (ID: ${data.layout.id})`, 'info');
                        addLog(`   Current content type: ${currentContentType}, Current layout: ${currentLayout?.id}`, 'info');
                        heartbeatText.textContent = `Layout: ${data.layout.name}`;
                        
                        // Check if we need to switch
                        const needsSwitch = currentContentType !== 'layout' || !currentLayout || currentLayout.id !== data.layout.id;
                        addLog(`   Needs switch: ${needsSwitch}`, 'info');
                        
                        if (needsSwitch) {
                            addLog(`‚ñ∂ Switching to layout (${data.layout.regions?.length || 0} regions)`, 'success');
                            document.getElementById('setup-screen').style.display = 'none';
                            document.getElementById('player-container').style.display = 'block';
                            document.getElementById('fullscreen-btn').classList.add('active');
                            hideResetButton();
                            renderLayout(data.layout);
                            currentContentType = 'layout';
                        } else {
                            addLog(`   Already showing this layout, no switch needed`, 'info');
                        }
                        startHeartbeat();
                    }
                    // Legacy support - if no type specified, assume layout
                    else if (data.layout) {
                        addLog(`üìê Legacy response, showing layout: "${data.layout.name}" (ID: ${data.layout.id})`, 'info');
                        addLog(`   Current content type: ${currentContentType}`, 'info');
                        heartbeatText.textContent = `Layout: ${data.layout.name}`;
                        
                        const needsSwitch = currentContentType !== 'layout' || !currentLayout || currentLayout.id !== data.layout.id;
                        addLog(`   Needs switch: ${needsSwitch}`, 'info');
                        
                        if (needsSwitch) {
                            addLog(`‚ñ∂ Switching to layout (${data.layout.regions?.length || 0} regions)`, 'success');
                            document.getElementById('setup-screen').style.display = 'none';
                            document.getElementById('player-container').style.display = 'block';
                            document.getElementById('fullscreen-btn').classList.add('active');
                            hideResetButton();
                            renderLayout(data.layout);
                            currentContentType = 'layout';
                        } else {
                            addLog(`   Already showing this layout, no switch needed`, 'info');
                        }
                        startHeartbeat();
                    } else {
                        // No content assigned yet, keep showing setup screen
                        addLog('‚è≥ No layout or schedule assigned yet, waiting...', 'warning');
                        document.getElementById('setup-screen').style.display = 'flex';
                        document.getElementById('player-container').style.display = 'none';
                        document.getElementById('fullscreen-btn').classList.remove('active');
                        document.getElementById('code-input-section').style.display = 'none';
                        document.getElementById('token-input-section').style.display = 'none';
                        document.getElementById('setup-message').textContent = 'Connected! Waiting for layout assignment...';
                        currentContentType = null;
                        stopHeartbeat();
                        setTimeout(checkForContent, 10000);
                    }
                } else {
                    heartbeatIndicator.classList.remove('checking');
                    heartbeatText.textContent = 'Heartbeat Active';
                    addLog(`‚úó Unexpected response status: ${response.status}`, 'error');
                    const errorText = await response.text();
                    showError(`Server error: ${response.status}`);
                    setTimeout(checkForContent, 10000);
                }
            } catch (error) {
                addLog(`‚úó Connection error: ${error.message}`, 'error');
                showError(`Connection error: ${error.message}. Retrying...`);
                heartbeatIndicator.classList.remove('checking');
                heartbeatText.textContent = 'Connection Error';
                setTimeout(checkForContent, 10000);
            }
        }

        // Start heartbeat - checks for schedule changes every 5 seconds
        function startHeartbeat() {
            if (heartbeatInterval) {
                return; // Already running
            }
            addLog('üíì Heartbeat started (checking every 5 seconds)', 'success');
            
            // Show heartbeat indicator
            const heartbeatIndicator = document.getElementById('heartbeat-indicator');
            heartbeatIndicator.classList.add('active');
            
            heartbeatInterval = setInterval(() => {
                addLog('üíì Heartbeat pulse - checking for schedule changes...', 'info');
                checkForContent();
            }, 5000); // Check every 5 seconds
        }

        // Stop heartbeat
        function stopHeartbeat() {
            if (heartbeatInterval) {
                addLog('üíî Heartbeat stopped', 'warning');
                clearInterval(heartbeatInterval);
                heartbeatInterval = null;
                
                // Hide heartbeat indicator
                const heartbeatIndicator = document.getElementById('heartbeat-indicator');
                heartbeatIndicator.classList.remove('active');
            }
        }

        // Render layout with regions
        function renderLayout(layout) {
            const container = document.getElementById('player-container');
            container.innerHTML = '';
            
            // Set container size to match layout
            container.style.width = `${layout.width}px`;
            container.style.height = `${layout.height}px`;
            
            // Scale to fit screen
            const scaleX = window.innerWidth / layout.width;
            const scaleY = window.innerHeight / layout.height;
            const scale = Math.min(scaleX, scaleY);
            
            container.style.transform = `scale(${scale})`;
            container.style.transformOrigin = 'top left';
            container.style.left = `${(window.innerWidth - layout.width * scale) / 2}px`;
            container.style.top = `${(window.innerHeight - layout.height * scale) / 2}px`;

            // Render each region
            if (layout.regions && layout.regions.length > 0) {
                layout.regions.forEach(region => {
                    renderRegion(region);
                });
            }

            currentLayout = layout;
            currentPlaylistId = null; // Clear playlist ID since we're showing layout
        }

        // Render scheduled playlist (fullscreen)
        function renderScheduledPlaylist(playlist) {
            const container = document.getElementById('player-container');
            container.innerHTML = '';
            
            // Set container to fullscreen
            container.style.width = '100vw';
            container.style.height = '100vh';
            container.style.transform = 'none';
            container.style.left = '0';
            container.style.top = '0';

            // Play playlist contents in sequence
            if (playlist.contents && playlist.contents.length > 0) {
                playPlaylistFullscreen(container, playlist.contents);
            }

            currentLayout = null; // Clear layout since we're showing playlist
            currentPlaylistId = playlist.id; // Track current playlist
        }

        // Play playlist in fullscreen
        function playPlaylistFullscreen(container, contents) {
            let currentIndex = 0;

            function showNext() {
                if (contents.length === 0) return;

                const content = contents[currentIndex];
                container.innerHTML = '';

                if (content.type === 'image') {
                    const img = document.createElement('img');
                    img.src = `${API_URL.replace('/api', '')}/storage/${content.file_path}`;
                    img.style.width = '100%';
                    img.style.height = '100%';
                    img.style.objectFit = 'contain';
                    container.appendChild(img);
                } else if (content.type === 'video') {
                    const video = document.createElement('video');
                    video.src = `${API_URL.replace('/api', '')}/storage/${content.file_path}`;
                    video.autoplay = true;
                    video.muted = true;
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'contain';
                    container.appendChild(video);
                }

                const duration = content.duration || 10;
                setTimeout(() => {
                    currentIndex = (currentIndex + 1) % contents.length;
                    showNext();
                }, duration * 1000);
            }

            showNext();
        }

        // Render individual region
        function renderRegion(region) {
            const container = document.getElementById('player-container');
            const regionDiv = document.createElement('div');
            regionDiv.className = 'region';
            regionDiv.style.width = `${region.width}px`;
            regionDiv.style.height = `${region.height}px`;
            regionDiv.style.top = `${region.top}px`;
            regionDiv.style.left = `${region.left}px`;
            regionDiv.style.zIndex = region.z_index;

            // Handle content or playlist
            if (region.content) {
                displayContent(regionDiv, region.content);
            } else if (region.playlist && region.playlist.contents) {
                playPlaylist(regionDiv, region.playlist.contents);
            }

            container.appendChild(regionDiv);
        }

        // Display single content item
        function displayContent(container, content) {
            container.innerHTML = '';
            
            if (content.type === 'image') {
                const img = document.createElement('img');
                img.src = `${API_URL.replace('/api', '')}/storage/${content.file_path}`;
                container.appendChild(img);
            } else if (content.type === 'video') {
                const video = document.createElement('video');
                video.src = `${API_URL.replace('/api', '')}/storage/${content.file_path}`;
                video.autoplay = true;
                video.loop = true;
                video.muted = true;
                container.appendChild(video);
            }
        }

        // Play playlist in region
        function playPlaylist(container, contents) {
            let currentIndex = 0;

            function showNext() {
                if (contents.length === 0) return;

                const content = contents[currentIndex];
                displayContent(container, content);

                const duration = content.duration || 10;
                setTimeout(() => {
                    currentIndex = (currentIndex + 1) % contents.length;
                    showNext();
                }, duration * 1000);
            }

            showNext();
        }

        // Show error message
        function showError(message) {
            const errorDiv = document.getElementById('error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Show reset button
        function showResetButton() {
            const resetBtn = document.getElementById('reset-button');
            resetBtn.classList.add('visible');
        }

        // Hide reset button
        function hideResetButton() {
            const resetBtn = document.getElementById('reset-button');
            resetBtn.classList.remove('visible');
        }

        // Reset player
        function resetPlayer() {
            if (confirm('This will clear your saved code and token. Continue?')) {
                localStorage.removeItem('displayCode');
                localStorage.removeItem('playerToken');
                stopHeartbeat();
                location.reload();
            }
        }

        // Fullscreen functionality
        function toggleFullscreen() {
            const elem = document.documentElement;
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            const exitFullscreenIcon = document.getElementById('exit-fullscreen-icon');

            if (!document.fullscreenElement && !document.webkitFullscreenElement && 
                !document.mozFullScreenElement && !document.msFullscreenElement) {
                // Enter fullscreen
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        // Update fullscreen button icon
        function updateFullscreenButton() {
            const fullscreenIcon = document.getElementById('fullscreen-icon');
            const exitFullscreenIcon = document.getElementById('exit-fullscreen-icon');
            
            if (document.fullscreenElement || document.webkitFullscreenElement || 
                document.mozFullScreenElement || document.msFullscreenElement) {
                fullscreenIcon.style.display = 'none';
                exitFullscreenIcon.style.display = 'block';
            } else {
                fullscreenIcon.style.display = 'block';
                exitFullscreenIcon.style.display = 'none';
            }
        }

        // Setup fullscreen button
        function setupFullscreenButton() {
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            fullscreenBtn.addEventListener('click', toggleFullscreen);

            // Listen for fullscreen changes
            document.addEventListener('fullscreenchange', updateFullscreenButton);
            document.addEventListener('webkitfullscreenchange', updateFullscreenButton);
            document.addEventListener('mozfullscreenchange', updateFullscreenButton);
            document.addEventListener('MSFullscreenChange', updateFullscreenButton);

            // Keyboard shortcut: F key for fullscreen
            document.addEventListener('keydown', (e) => {
                if (e.key === 'f' || e.key === 'F') {
                    toggleFullscreen();
                }
            });
        }

        // Initialize player
        async function init() {
            addLog('üöÄ Player initializing...', 'info');
            addLog(`API URL: ${API_URL}`, 'info');
            
            displayCode = getDisplayCode();
            playerToken = getStoredToken();
            
            if (displayCode) {
                addLog(`Display code loaded: ${displayCode}`, 'info');
            }
            if (playerToken) {
                addLog('Player token loaded from storage', 'info');
            }
            
            setupCodeInput();
            setupTokenInput();
            setupFullscreenButton();
            setupDebugLog();
            
            // Check if we already have code and token
            if (displayCode && playerToken) {
                document.getElementById('code-input-section').style.display = 'none';
                document.getElementById('token-input-section').style.display = 'none';
                document.getElementById('display-code').textContent = displayCode;
                document.getElementById('setup-message').textContent = 'Connecting...';
                
                // Try to register first, then check for content
                const success = await registerDisplay();
                if (success) {
                    setTimeout(() => {
                        checkForContent();
                        // Note: heartbeat will be started by checkForContent() once content is loaded
                    }, 1000);
                }
            } else if (displayCode) {
                // Have code but no token
                document.getElementById('code-input-section').style.display = 'none';
                document.getElementById('token-input-section').style.display = 'block';
                document.getElementById('display-code').textContent = displayCode;
                document.getElementById('setup-message').textContent = 'Enter the global player token';
            }
            // else: show code input (default state)
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (currentLayout) {
                    renderLayout(currentLayout);
                }
            });
        }

        // Setup debug log controls
        function setupDebugLog() {
            const toggle = document.getElementById('debug-log-toggle');
            const closeBtn = document.getElementById('debug-log-close');
            const forceRefreshBtn = document.getElementById('force-refresh-btn');
            
            toggle.addEventListener('click', toggleDebugLog);
            closeBtn.addEventListener('click', toggleDebugLog);
            forceRefreshBtn.addEventListener('click', forceRefresh);
            
            // Show debug log by default
            toggleDebugLog();
        }

        // Force refresh content
        function forceRefresh() {
            addLog('üîÑ Force refresh triggered by user', 'warning');
            checkForContent();
        }

        // Start player when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
